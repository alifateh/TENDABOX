<!doctype html>
<html lang="en">
  <!--begin::Head-->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>TendaBox</title>
    <!--begin::Accessibility Meta Tags-->

    <!--end::Accessibility Meta Tags-->
    <!--begin::Primary Meta Tags-->
    <meta name="title" content="TendaBox" />
    <meta name="author" content="M.A.Fatehchehr" />
    <!--
    <meta
      name="description"
      content=""
    />
    <meta
      name="keywords"
      content=""
    />
    -->
    <!--end::Primary Meta Tags-->
    <!--begin::Accessibility Features-->
    <!-- Skip links will be dynamically added by accessibility.js -->
    <script>
      // قبل از لود شدن بقیه المان‌ها دسترسی را چک کن
      (async () => {
        const res = await fetch("/api/v1/user/MyMenu");
        const result = await res.json();
        const currentPath = window.location.pathname;

        // اگر صفحه فعلی در لیست مجاز نبود (به جز داشبورد)
        if (
          currentPath !== "/dashboard" &&
          !result.data.some((m) => m.url === currentPath)
        ) {
          window.location.href = "/dashboard?error=unauthorized";
        }
      })();
    </script>
    <style>
      /* نمایش اجباری لیست اصلی */
      #mainMenu {
        display: flex !important;
        flex-direction: column !important;
        opacity: 1 !important;
        visibility: visible !important;
        list-style: none !important;
        padding: 0 !important;
      }

      /* استایل آیتم‌های منو */
      .nav-item {
        width: 100% !important;
        display: block !important; /* تغییر از none به block */
      }

      /* زیرمنوها در حالت عادی مخفی باشند */
      .nav-treeview {
        display: none !important;
      }

      /* زیرمنوها وقتی کلاس menu-open اضافه شد نمایش داده شوند */
      .menu-open > .nav-treeview {
        display: block !important;
      }

      .nav-link {
        cursor: pointer !important;
      }
    </style>
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="./static/images/favicon.ico"
    />
    <link rel="preload" href="./static/css/adminlte.css" as="style" />
    <!--end::Accessibility Features-->
    <!--begin::Fonts-->
    <link
      rel="stylesheet"
      href="./static/css/index.css"
      integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q="
      media="print"
      onload="this.media = 'all'"
    />
    <!--end::Fonts-->
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <link rel="stylesheet" href="./static/css/overlayscrollbars.min.css" />
    <!--end::Third Party Plugin(OverlayScrollbars)-->
    <!--begin::Third Party Plugin(Bootstrap Icons)-->
    <link rel="stylesheet" href="./static/css/bootstrap-icons.min.css" />
    <!--end::Third Party Plugin(Bootstrap Icons)-->
    <!--begin::Required Plugin(AdminLTE)-->
    <link rel="stylesheet" href="./static/css/adminlte.css" />
    <!--end::Required Plugin(AdminLTE)-->
    <!-- apexcharts -->
    <link rel="stylesheet" href="./static/css/apexcharts.css" />
  </head>
  <body class="layout-fixed sidebar-expand-lg sidebar-open bg-body-tertiary">
    <!--begin::App Wrapper-->
    <div class="app-wrapper">
      <!--begin::Header-->
      <nav class="app-header navbar navbar-expand bg-body">
        <!--begin::Container-->
        <div class="container-fluid">
          <!--begin::Start Navbar Links-->
          <ul class="navbar-nav">
            <li class="nav-item">
              <a
                class="nav-link"
                data-lte-toggle="sidebar"
                href="#"
                role="button"
              >
                <i class="bi bi-list"></i>
              </a>
            </li>
          </ul>
          <!--end::Start Navbar Links-->
          <!--begin::End Navbar Links-->
          <ul class="navbar-nav ms-auto">
            <!--begin::Navbar Search-->
            <!--end::Navbar Search-->
            <!--begin::Messages Dropdown Menu-->
            <!--end::Messages Dropdown Menu-->
            <!--begin::Notifications Dropdown Menu-->
            <li class="nav-item dropdown">
              <a class="nav-link" data-bs-toggle="dropdown" href="#">
                <i class="bi bi-bell-fill"></i>
                <span class="navbar-badge badge text-bg-warning">15</span>
              </a>
              <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                <span class="dropdown-item dropdown-header"
                  >15 Notifications</span
                >
              </div>
            </li>
            <!--end::Notifications Dropdown Menu-->
            <!--begin::Fullscreen Toggle-->
            <li class="nav-item">
              <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                <i
                  data-lte-icon="minimize"
                  class="bi bi-fullscreen-exit"
                  style="display: none"
                ></i>
              </a>
            </li>
            <!--end::Fullscreen Toggle-->
            <!--begin::User Menu Dropdown-->
            <li class="nav-item dropdown user-menu">
              <a
                href="#"
                class="nav-link dropdown-toggle"
                data-bs-toggle="dropdown"
              >
                <img
                  src="./static/images/avatar.png"
                  class="user-image rounded-circle shadow"
                  alt="User Image"
                />
                <span class="d-none d-md-inline"></span>
              </a>
              <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                <!--begin::User Image-->
                <li class="user-header text-bg-primary">
                  <img
                    src="./static/images/avatar.png"
                    class="rounded-circle shadow"
                    alt="User Image"
                  />
                  <p>
                    User name???
                    <small id="userInfo"> Loading ... </small>
                  </p>
                </li>
                <!--end::User Image-->
                <!--begin::Menu Body-->
                <!--end::Menu Body-->
                <!--begin::Menu Footer-->
                <li class="user-footer">
                  <a href="#" class="btn btn-default btn-flat">Profile</a>
                  <a
                    href="#"
                    class="btn btn-default btn-flat float-end"
                    onclick="logout()"
                    >Sign out</a
                  >
                </li>
                <!--end::Menu Footer-->
              </ul>
            </li>
            <!--end::User Menu Dropdown-->
          </ul>
          <!--end::End Navbar Links-->
        </div>
        <!--end::Container-->
      </nav>
      <!--end::Header-->
      <!--begin::Sidebar-->
      <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <div class="sidebar-wrapper">
          <nav class="mt-2">
            <ul
              class="nav sidebar-menu flex-column"
              data-lte-toggle="treeview"
              role="menu"
              id="mainMenu"
              style="visibility: hidden"
            >
              <li class="nav-item" data-level="50">
                <a href="/dashboard" class="nav-link">
                  <i class="nav-icon bi bi-speedometer"></i>
                  <p>Dashboard</p>
                </a>
              </li>

              <li class="nav-item" data-level="2000">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-shield-lock"></i>
                  <p>
                    System Control <i class="nav-arrow bi bi-chevron-right"></i>
                  </p>
                </a>
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="/admin/security" class="nav-link"
                      ><i class="bi bi-circle"></i>
                      <p>User Security & Roles</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/admin/system/health" class="nav-link"
                      ><i class="bi bi-terminal"></i>
                      <p>System Health & Logs</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/admin/settings" class="nav-link"
                      ><i class="bi bi-gear"></i>
                      <p>Global Settings</p></a
                    >
                  </li>
                </ul>
              </li>

              <li class="nav-item" data-level="1000">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-people"></i>
                  <p>
                    Administration <i class="nav-arrow bi bi-chevron-right"></i>
                  </p>
                </a>
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="/admin/users" class="nav-link"
                      ><i class="bi bi-circle"></i>
                      <p>User Management</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/admin/vendors/approve" class="nav-link"
                      ><i class="bi bi-person-check"></i>
                      <p>Vendor Approval</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/admin/reports" class="nav-link"
                      ><i class="bi bi-graph-up-arrow"></i>
                      <p>Executive Reports</p></a
                    >
                  </li>
                </ul>
              </li>

              <li class="nav-item" data-level="800">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-pennant"></i>
                  <p>
                    Procurement <i class="nav-arrow bi bi-chevron-right"></i>
                  </p>
                </a>
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="/procurement/tenders" class="nav-link"
                      ><i class="bi bi-circle"></i>
                      <p>Tender Management</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/procurement/evaluations" class="nav-link"
                      ><i class="bi bi-clipboard-check"></i>
                      <p>Technical Evaluation</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/procurement/ai-score" class="nav-link"
                      ><i class="bi bi-cpu"></i>
                      <p>AI Scoring Engine</p></a
                    >
                  </li>
                </ul>
              </li>

              <li class="nav-item" data-level="700">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-receipt"></i>
                  <p>Finance <i class="nav-arrow bi bi-chevron-right"></i></p>
                </a>
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="/finance/invoices" class="nav-link"
                      ><i class="bi bi-circle"></i>
                      <p>Invoices & Payments</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/finance/budget" class="nav-link"
                      ><i class="bi bi-wallet2"></i>
                      <p>Budget Control</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/finance/audit-trail" class="nav-link"
                      ><i class="bi bi-currency-dollar"></i>
                      <p>Financial Audit Trail</p></a
                    >
                  </li>
                </ul>
              </li>

              <li class="nav-item" data-level="600">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-shredder"></i>
                  <p>Audit <i class="nav-arrow bi bi-chevron-right"></i></p>
                </a>
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="/audit/dashboard" class="nav-link"
                      ><i class="bi bi-circle"></i>
                      <p>Audit Dashboard</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/audit/logs" class="nav-link"
                      ><i class="bi bi-journal-text"></i>
                      <p>All Activity Logs</p></a
                    >
                  </li>
                </ul>
              </li>

              <li class="nav-item" data-level="100">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-building"></i>
                  <p>
                    Vendor Portal <i class="nav-arrow bi bi-chevron-right"></i>
                  </p>
                </a>
                <ul class="nav nav-treeview">
                  <li class="nav-item" data-level="500">
                    <a href="/vendor/tenders-premium" class="nav-link"
                      ><i class="bi bi-star-fill"></i>
                      <p>Premium Tenders</p></a
                    >
                  </li>
                  <li class="nav-item" data-level="500">
                    <a href="/vendor/proposals" class="nav-link"
                      ><i class="bi bi-send"></i>
                      <p>My Proposals</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/public/tenders" class="nav-link"
                      ><i class="bi bi-megaphone"></i>
                      <p>Public Tenders</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/vendor/profile" class="nav-link"
                      ><i class="bi bi-person"></i>
                      <p>Company Profile</p></a
                    >
                  </li>
                </ul>
              </li>

              <li class="nav-item" data-level="400">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-cart"></i>
                  <p>
                    Purchasing <i class="nav-arrow bi bi-chevron-right"></i>
                  </p>
                </a>
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="/buyer/requests" class="nav-link"
                      ><i class="bi bi-circle"></i>
                      <p>My Purchase Requests</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/buyer/requests/new" class="nav-link"
                      ><i class="bi bi-cart-plus"></i>
                      <p>Create New PR</p></a
                    >
                  </li>
                </ul>
              </li>

              <li class="nav-item" data-level="50">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-search"></i>
                  <p>
                    Public Info <i class="nav-arrow bi bi-chevron-right"></i>
                  </p>
                </a>
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="/directory" class="nav-link"
                      ><i class="bi bi-circle"></i>
                      <p>Public Directory</p></a
                    >
                  </li>
                  <li class="nav-item">
                    <a href="/stats/public" class="nav-link"
                      ><i class="bi bi-pie-chart"></i>
                      <p>General Statistics</p></a
                    >
                  </li>
                </ul>
              </li>
            </ul>
          </nav>
        </div>
      </aside>
      <!--end::Sidebar-->
      <!--begin::App Main-->
      <main class="app-main">
        <!--begin::App Content Header-->
        <div class="app-content-header">
          <!--begin::Container-->
          <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
              <div class="col-sm-6"><h3 class="mb-0">Dashboard</h3></div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item"><a href="#">Home</a></li>
                  <li class="breadcrumb-item active" aria-current="page">
                    Dashboard
                  </li>
                </ol>
              </div>
            </div>
            <!--end::Row-->
          </div>
          <!--end::Container-->
        </div>
        <div class="app-content">
          <!--begin::Container-->
          <div class="container-fluid">
            <!-- Info boxes -->
            <div class="row">
              <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                  <span class="info-box-icon text-bg-primary shadow-sm">
                    <i class="bi bi-box-seam"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Goods</span>
                    <span class="info-box-number"> 20 </span>
                  </div>
                  <!-- /.info-box-content -->
                </div>
                <!-- /.info-box -->
              </div>
              <!-- /.col -->
              <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                  <span class="info-box-icon text-bg-danger shadow-sm">
                    <i class="bi bi-rocket-takeoff"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Services</span>
                    <span class="info-box-number">39</span>
                  </div>
                  <!-- /.info-box-content -->
                </div>
                <!-- /.info-box -->
              </div>
              <!-- /.col -->
              <!-- fix for small devices only -->
              <!-- <div class="clearfix hidden-md-up"></div> -->
              <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                  <span class="info-box-icon text-bg-success shadow-sm">
                    <i class="bi bi-layers-half"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">New</span>
                    <span class="info-box-number">29</span>
                  </div>
                  <!-- /.info-box-content -->
                </div>
                <!-- /.info-box -->
              </div>
              <!-- /.col -->
              <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                  <span class="info-box-icon text-bg-warning shadow-sm">
                    <i class="bi bi-clock-history"></i>
                  </span>
                  <div class="info-box-content">
                    <span class="info-box-text">Expiring</span>
                    <span class="info-box-number">6</span>
                  </div>
                  <!-- /.info-box-content -->
                </div>
                <!-- /.info-box -->
              </div>
              <!-- /.col -->
            </div>
            <!-- /.row -->
            <!--begin::Row-->
            <div class="row">
              <div class="col-md-12">
                <div class="card mb-12">
                  <div class="card-header">
                    <h5 class="card-title">Monthly Recap Report</h5>
                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-lte-toggle="card-collapse"
                      >
                        <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                        <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-lte-toggle="card-remove"
                      >
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </div>
                  <!-- /.card-header -->
                  <div class="card-body">
                    <!--begin::Row-->
                    <div class="row">
                      <!-- /.card-header -->
                      <div class="card-body">
                        <!--begin::Row-->
                        <div class="row">
                          <div class="col-4"><div id="pie-chart"></div></div>
                          <!-- /.col -->
                        </div>
                        <!--end::Row-->
                      </div>
                      <!-- /.card-body -->

                      <!-- /.footer -->
                    </div>
                  </div>
                  <!--end::Row-->
                </div>
                <!-- /.card-footer -->
              </div>
              <!-- /.card -->
            </div>
            <!-- /.col -->
          </div>
          <!--end::Row-->
          <!--begin::Row-->
          <!--end::Row-->
        </div>
        <!--end::Container-->
        <!--end::App Content-->
      </main>
      <!--end::App Main-->
      <!--begin::Footer-->
      <footer class="app-footer">
        <strong>
          Copyright &copy; <span id="current-year"></span>&nbsp;
          <a href="#" class="text-decoration-none">TendaBox</a>.
        </strong>
        All rights reserved.
      </footer>
      <!--end::Footer-->
    </div>
    <!--end::App Wrapper-->
    <!--begin::Script-->
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <script src="./static/js/overlayscrollbars.browser.es6.min.js"></script>
    <!--end::Third Party Plugin(OverlayScrollbars)--><!--begin::Required Plugin(popperjs for Bootstrap 5)-->
    <script src="./static/js/popper.min.js"></script>
    <!--end::Required Plugin(popperjs for Bootstrap 5)--><!--begin::Required Plugin(Bootstrap 5)-->
    <script src="./static/js/bootstrap.min.js"></script>
    <!--end::Required Plugin(Bootstrap 5)--><!--begin::Required Plugin(AdminLTE)-->
    <script src="./static/js/adminlte.js"></script>
    <!--end::Required Plugin(AdminLTE)--><!--begin::OverlayScrollbars Configure-->
    <script>
      const SELECTOR_SIDEBAR_WRAPPER = ".sidebar-wrapper";
      const Default = {
        scrollbarTheme: "os-theme-light",
        scrollbarAutoHide: "leave",
        scrollbarClickScroll: true,
      };
      document.addEventListener("DOMContentLoaded", function () {
        const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
        if (
          sidebarWrapper &&
          OverlayScrollbarsGlobal?.OverlayScrollbars !== undefined
        ) {
          OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
            scrollbars: {
              theme: Default.scrollbarTheme,
              autoHide: Default.scrollbarAutoHide,
              clickScroll: Default.scrollbarClickScroll,
            },
          });
        }
      });
      document.getElementById("current-year").innerHTML =
        new Date().getFullYear();
    </script>
    <!--end::OverlayScrollbars Configure-->
    <!-- apexcharts -->
    <script src="./static/js/apexcharts.min.js"></script>
    <!-- OPTIONAL SCRIPTS -->
    <script>
      // NOTICE!! DO NOT USE ANY OF THIS JAVASCRIPT
      // IT'S ALL JUST JUNK FOR DEMO
      // ++++++++++++++++++++++++++++++++++++++++++

      /* apexcharts
       * -------
       * Here we will create a few charts using apexcharts
       */

      //-------------
      // - PIE CHART -
      //-------------

      const pie_chart_options = {
        series: [44, 11, 3, 1],
        chart: {
          type: "donut",
        },
        labels: ["NGO", "Government", "Funding opportunity", "Corporate"],
        dataLabels: {
          enabled: false,
        },
        colors: ["#0d6efd", "#20c997", "#ffc107", "#d63384"],
      };

      const pie_chart = new ApexCharts(
        document.querySelector("#pie-chart"),
        pie_chart_options,
      );
      pie_chart.render();

      //-----------------
      // - END PIE CHART -
      //-----------------
    </script>
    <script>
      function logout() {
        document.cookie =
          "auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.href = "/";
      }

      async function filterMenuByNumericLevel() {
        //console.log("Starting menu filter...");
        try {
          const response = await fetch("/api/v1/user/Accesslevel");
          if (!response.ok) throw new Error("API Response Error");

          const result = await response.json();
          const roleName = result.level.toLowerCase().trim(); 
          //console.log("User Role Name:", roleName);

          const roleToLevel = {
            super_admin: 2000,
            admin: 1000,
            procurement: 800,
            finance: 700,
            auditor: 600,
            vendor_premium: 500,
            buyer: 400,
            vendor_public: 100,
            user: 50,
            guest: 50,
          };
          const userLevel = roleToLevel[roleName] || 50;
          //console.log("User Translated Level:", userLevel);

          const menuItems = document.querySelectorAll(
            "#mainMenu > li[data-level]",
          );

          menuItems.forEach((item) => {
            const minRequiredLevel = parseInt(item.getAttribute("data-level"));

            if (userLevel >= minRequiredLevel) {
              item.style.setProperty("display", "block", "important");
              //console.log(
              //  `✅ Showing: ${item.innerText.split("\n")[0]} (Req: ${minRequiredLevel})`,
              //);
            } else {
              //console.log(
              //  `❌ Removing: ${item.innerText.split("\n")[0]} (Req: ${minRequiredLevel})`,
              //);
              item.remove();
            }
          });

          
          const mainMenu = document.getElementById("mainMenu");
          mainMenu.style.setProperty("visibility", "visible", "important");
          mainMenu.style.setProperty("opacity", "1", "important");
        } catch (error) {
          console.error("Filter Logic Error:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", filterMenuByNumericLevel);
    </script>
    <!--end::Script-->
  </body>
  <!--end::Body-->
</html>
